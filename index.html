// --- 基礎設定 ---
const params = new URLSearchParams(window.location.search);
const channel = params.get('channel') || 'rakenluck111';
const targetReward = params.get('reward') || "放鞭炮";

// --- 佇列系統核心 ---
let effectQueue = []; // 存放等待播放的兌換資料
let isPlaying = false; // 目前是否正在播放動畫

const quotes = [
    "新的一年，垃圾桶裡都是寶藏！",
    "新的一年，剪輯速度突破天際！",
    "新的一年，所有霉運都被炸飛啦！",
    "新的一年，浣熊尾巴又順又亮！"
];

// 當 Twitch 收到兌換時
ComfyJS.onRewardRedemption = (user, reward, cost, message) => {
    if (reward === targetReward) {
        // 將使用者加入排隊名單，不直接執行
        effectQueue.push({ user: user, message: message });
        checkQueue(); 
    }
};

// 檢查隊伍狀況
function checkQueue() {
    // 如果目前沒人在播放，且隊伍裡有人的話
    if (!isPlaying && effectQueue.length > 0) {
        const nextData = effectQueue.shift(); // 取出隊伍第一個人
        startAnimation(nextData.user);
    }
}

function startAnimation(user) {
    isPlaying = true;
    const textDisplay = document.getElementById('text-display');
    const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
    
    // 顯示文案
    textDisplay.innerHTML = `<div>${user} 驅散了霉運</div><div style="font-size: 32px">${randomQuote}</div>`;
    textDisplay.style.opacity = 1;
    textDisplay.style.transform = "scale(1.2)";

    // 觸發視覺效果
    document.body.classList.add('shaking');
    for(let i=0; i<50; i++) { createParticle(); }

    // 設定播放時間（例如 4 秒後結束並換下一個）
    setTimeout(() => {
        textDisplay.style.opacity = 0;
        textDisplay.style.transform = "scale(0.5)";
        document.body.classList.remove('shaking');
        
        isPlaying = false; // 標記播放結束
        checkQueue(); // 繼續檢查隊伍是否有下一個人
    }, 4000); 
}

// --- 以下保留你之前的 Token 處理與粒子產生邏輯 ---
ComfyJS.Init(channel);
